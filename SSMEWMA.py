# -*- coding: utf-8 -*-
"""
Created on Mon Dec 16 09:19:22 2024

@author: tbeene
"""

from scipy.linalg import qr, solve_triangular
import numpy as np 
import pandas as pd 
from scipy.stats import norm 
from numpy import linalg as LA 
from scipy.stats import norm, t


# Load data
def generate_multivariate_data(cov, data, run_length):
    """ Generate synthetic multivariate normal data. """
    means = np.mean(data, axis=0)
    samples = np.random.multivariate_normal(mean=means, cov=cov, size=run_length)
    return pd.DataFrame(samples, columns=data.columns)


def compute_recursive_residuals(X): 
    """ 
    Compute the recursive residuals matrix R following the approach in Hawkins 
    """ 
    X = np.array(X, dtype=np.float64)
    n, p = X.shape 
    R = np.full((n, p), np.nan) # Initialize R with NaNs 
    X = np.hstack((np.ones((n, 1)), X)) # Add intercept column 
    for j in range(1, p+1): # Loop over each variable 
        for i in range(j, n): # Start from the second available observation 
            # Define the regression dataset 
            y = X[:i, j] # Current target variable (column j) 
            y_act = X[i, j] # Actual value for current observation 
            # QR factorization instead of Cholesky 
            Q, R_qr = qr(X[:i, :j], mode='economic') # Compute QR decomposition 
            beta = solve_triangular(R_qr, Q.T @ y, lower = False) # Solve for regression coefficients 
         
            y_pred = X[i, :j] @ beta # Compute predicted value 
            residual = y_act - y_pred # Compute residual 
           
            # Compute leverage using QR 
            if np.linalg.det(X[:i, :j].T @ X[:i, :j]) != 0:
                h_ij = X[i, :j] @ np.linalg.inv(X[:i, :j].T @ X[:i, :j]) @ X[i, :j]
            else:
                h_ij = 0
            # Normalize recursive residual 
            R[i, j-1] = residual / np.sqrt(1 + h_ij) 
          
    # Small mistake in Hawkins paper, if adding this line results match exactly with Table 
    # R[5][4] = -0.002
    return R 

def transform_to_U(R):
    """
    Compute studentized residuals 
    """
    U = np.full(R.shape, np.nan)
    n, p = R.shape
    for j in range(p):
        for i in range(j+1,n):
            # Only compute for defined residuals, i.e. i > j
            df = i - j - 1 # degrees of freedom according to the paper
            # Only transform if df > 0 (i.e. at least 3 observations in the regression)
            if df > 0:
                t_n_i = R[i, j]/np.sqrt(np.sum((R[j+1:i, j]**2)/(df)))
                # Compute the cumulative probability of the t-statistic
                p_val = t.cdf(t_n_i, df)
                # Transform to the corresponding quantile of the standard normal
                U[i, j] = norm.ppf(p_val)   
    return U

def calc_M(U, Lambda):
    """ Compute MEWMA statistic. """
    U[np.isnan(U)] = 0
    o, p = U.shape
    M_list = np.zeros_like(U)
    for n in range(0, len(U)):
        if n >= p+1:
            M_list[n] = Lambda * U[n] + (1 - Lambda) * M_list[n-1]
    return M_list

def calc_T2_and_limits(M, Lambda, h):
    """ Compute TÂ² statistics and corresponding control limits. """
    T2_list = []
    lim_list = []
    o, p = M.shape

    for n in range(0, len(M)):
        if n >= p+1:
            T2 = np.linalg.norm(M[n])**2
            T2_list.append(T2)
            limit = (Lambda * (1 - (1 - Lambda)**(2 * (n - p + 1))) / (2 - Lambda)) * h
            lim_list.append(limit)
        else:
            T2_list.append(0)
            lim_list.append(0)

    return T2_list, lim_list

def Calculate_SSEWMA_Norm_Lim(cluster_data, h_type=0):
    
    index = 0
    result_df = pd.DataFrame()
    
    # Number of groups
    k = len(cluster_data)

    for key, cluster in cluster_data.items():
        
        cluster_trans = cluster.copy().T
       
        # Number of sensors in a group
        n = len(cluster)
        Lambda = 0.25
        
        # Determine appropriate h value resulting in an ARL ic of 25 observations
        if k - 1 > 48:
            k = 48
        if n - 2 > 18:
            h = 100
        else:
            # Store in TXT in the future
            # These are numerically found values for h depending on number of groups and sensors in a group
            h = h_type*[[5.427072890045065, 6.966775383254869, 7.532793465730381, 8.469547675176265, 8.919805303010648, 9.258898379741444, 9.599875881884447, 9.819860892134198, 9.90563017440815, 10.131457025675749, 10.446073904004479, 10.59677686828109, 10.779150226867197, 10.896698712145685, 11.015661905808114, 11.088717257964642, 11.228450983506528, 11.316706926898446, 11.453532793305452, 11.59975235699077, 11.748227111254764, 11.776020563453159, 11.863607723062483, 11.971883960777168, 12.081320390118872, 12.242165927948644, 12.351054903968791, 12.362068617097158, 12.42941392685308, 12.505121023640458, 12.595249793194291, 12.807261289313708, 12.923143366493036, 12.979468433629862, 13.024631075774813, 13.069649297167295, 13.085188673449096, 13.16683291461402, 13.189153745405953, 13.219045237197577, 13.291864082180972, 13.291864082181778, 13.34363861951232, 13.53541980736775, 13.623930834339383, 13.666963677629763, 13.703067838883136, 13.741216576494956, 13.77166312458758],
              [7.053243036270425, 9.033801814549703, 10.091952921417182, 10.786901341956188, 11.294255398630767, 11.685841574855644, 11.955117454261092, 12.212103067735914, 12.424431486081868, 12.594929080490205, 12.893429121203283, 13.139920558148264, 13.279913593934154, 13.514537917190008, 13.60293387834689, 13.71291029567086, 13.799021809240365, 13.880067867294073, 14.011103639238131, 14.089825203946848, 14.156559172525787, 14.313813310028014, 14.38743915394184, 14.481608225123233, 14.65943785777412, 14.749806590346779, 14.82883348064973, 14.886288111179795, 15.003356390639077, 15.096055201898736, 15.197357374104813, 15.248034895758824, 15.396919578028845, 15.463285732598896, 15.61637525786362, 15.791841784405717, 15.90080252435539, 15.968657942896716, 16.08484410270704, 16.110033959742196, 16.153836949152627, 16.20189453377212, 16.45401947866729, 16.540735395631575, 16.607377411346732, 16.644596592837495, 16.808137558778952, 16.89649380064578, 16.94202721897458],
              [8.422517912489761, 10.558956648955677, 11.800987171302786, 12.391947261570149, 12.936408447755472, 13.497210907077985, 13.934650336975347, 14.167574493104778, 14.590042501838937, 14.82035913645929, 14.963159211994652, 15.128367736543474, 15.327471578611743, 15.540647760548563, 15.657139393238571, 15.924932111040027, 16.015638646810622, 16.108305921819866, 16.286439704864385, 16.41493204094397, 16.575333631052196, 16.649804803707866, 16.766935865732783, 16.815013736589062, 16.847986337798936, 16.909873360781088, 16.99096137821702, 17.126451991613873, 17.263134157075825, 17.334113555486375, 17.41852062429698, 17.491944450075053, 17.615947699169343, 17.684362668588825, 17.82857342775224, 17.888993675826658, 18.035089510986364, 18.08106778002383, 18.11738526691074, 18.231755341479673, 18.30327806368311, 18.505237035229797, 18.588697451323455, 18.648705461625266, 18.778375917545567, 18.881782578226947, 18.931753173447973, 19.11307414515445, 19.217835469504216],
              [10.091203799292181, 12.285153883613408, 13.552867034289143, 14.224164673388746, 14.841032525345389, 15.453663175434457, 15.930617945346587, 16.34509238082946, 16.647667381215715, 16.835951120306774, 17.215681231537857, 17.40804505627773, 17.639337056777343, 17.767195551581587, 17.950330192941674, 18.110030796774467, 18.20827594441542, 18.340684320131007, 18.51514802298008, 18.705247132946536, 18.814681155636837, 18.963588454033545, 19.018416159758857, 19.160967040983603, 19.26028898992913, 19.351690662730164, 19.420608584766192, 19.49901582041104, 19.715489548039407, 19.889695567167408, 19.97538989148108, 20.02707603812386, 20.127379583881332, 20.19376778104312, 20.32366076190777, 20.447305653294542, 20.550248397999976, 20.656358593170374, 20.721726452323423, 20.81171891469005, 20.92439527325067, 21.00207053399148, 21.063346655941196, 21.14943759851839, 21.222130455383983, 21.2962061570001, 21.313815932536652, 21.45990814268989, 21.48526074565866],
              [11.983309257182935, 14.318441702148018, 15.64453867257947, 16.297485869968437, 17.210478679418593, 17.423202899880707, 17.776601842816948, 18.129599426098814, 18.35195407278602, 18.571766531142984, 18.849811320569028, 19.276912361470572, 19.480026349617027, 19.802714277806203, 19.870974885497787, 20.04507946309331, 20.101145573349143, 20.298686509923975, 20.539714473271406, 20.627450448500362, 20.778476195339955, 20.82931908950612, 20.939516620550208, 21.03298549972921, 21.147575635244664, 21.321899586860546, 21.411617975093513, 21.55116778424751, 21.61080511512187, 21.71844748122618, 21.82126300464071, 21.954151362845806, 22.018417995224908, 22.05441156541566, 22.13039262132812, 22.249332538270654, 22.321014632014453, 22.45577479820097, 22.500522623910264, 22.60261144635625, 22.691745720903864, 22.743164680417987, 22.83201617995431, 22.956399810536, 23.03387462159301, 23.17302860073759, 23.26237563792108, 23.37120854830278, 23.39898103940899],
              [12.954917187324934, 15.49167121233604, 16.858676521040422, 17.879773357558484, 18.384639328866776, 18.782849730016608, 19.13524133674842, 19.718885685897305, 20.020995846238645, 20.244906711022768, 20.57475394455182, 20.784079464193795, 21.029372473007946, 21.184739173141683, 21.348548158151704, 21.48253680932305, 21.630143808717328, 21.845398372675835, 21.9845752232394, 22.09910288624943, 22.186506692599494, 22.505842364358475, 22.632184214815062, 22.714392741477635, 22.776470764405104, 22.93084211364257, 23.07324767240027, 23.209629799607974, 23.26964331749399, 23.432271380030784, 23.633334021828112, 23.65522199607591, 23.712751602067, 23.755598420656376, 23.86754624707013, 23.995110129048008, 24.11844724531202, 24.199221135393746, 24.264633570592075, 24.36500105500278, 24.438130271918418, 24.514420943456653, 24.641331428796, 24.728157167400706, 24.782106442776843, 24.876826026918796, 24.955039055530047, 25.021519562453665, 25.040690161750447],
              [14.962509249427958, 17.645309010737197, 18.85523297398013, 19.547554724412535, 20.129993673338515, 20.817967075117384, 21.062908807797367, 21.317207204667408, 21.583599346362156, 21.90441850670144, 22.331577253317555, 22.543593998629316, 22.808569518222033, 22.95384236416018, 23.160603014245197, 23.460147292280396, 23.60520451808725, 23.72814896825495, 23.884073222529043, 24.109134912452028, 24.289873043144922, 24.38883989176927, 24.547819714249712, 24.714052164812802, 24.743148644640073, 24.806204463021533, 24.966187055615602, 25.051317722337522, 25.22278654389362, 25.28341184289227, 25.356807577221556, 25.43124862256552, 25.570059283596148, 25.710768475250156, 25.891820177735124, 26.046745715706667, 26.158795526995206, 26.22666516050814, 26.369957433351008, 26.39532852174904, 26.563527529084723, 26.612189254651017, 26.78417234053316, 26.907271181279647, 27.021356792685495, 27.10285136558967, 27.215270642154476, 27.318707590149586, 27.418549426938704],
              [15.225648436623596, 18.00385346193954, 19.434653327200515, 20.243330918392655, 20.960372165844866, 21.550167491444935, 22.09917228651155, 22.678035451634614, 22.799090336478233, 23.183788071916005, 23.61283770990451, 24.015763249730462, 24.28595137421441, 24.404486509488517, 24.58802803110157, 24.73268641819939, 24.9199340430922, 25.0579869318923, 25.229665689116498, 25.421907685225108, 25.65671995603002, 25.805560170952077, 26.00119072877928, 26.082757381131355, 26.349027706055246, 26.436667564766537, 26.547352760916585, 26.687945186910024, 26.72420944726307, 26.975004274704528, 27.123498704710023, 27.22349137946798, 27.271269396747787, 27.589362823583883, 27.86670570934018, 28.011185906997383, 28.327305049467853, 28.361972618566153, 28.47947814604638, 28.676435458851653, 28.858339115091315, 29.14479257681831, 29.336014928316366, 29.35638419918879, 29.585967531166897, 29.92549444373104, 30.474596413794956, 30.576148100627, 30.938576688209896],
              [16.773283005087748, 20.417989835731724, 21.724474110330778, 22.51132048154107, 23.572734458890167, 24.279558623653703, 24.832562100073496, 25.099299519188236, 25.150466637646915, 25.35016553593339, 25.63398355841207, 25.872017040262378, 26.084736128892207, 26.565661058498485, 26.82302448408219, 27.05799897858244, 27.381894718876563, 27.46598143073275, 27.74154882967508, 27.843930156592876, 28.038208820081188, 28.319662590186375, 28.411434673131115, 28.49236606673665, 28.65744118131128, 28.903722092416366, 29.13124150886589, 29.2471847753689, 29.341397850314983, 29.45921114509415, 29.596416989936486, 29.60563016930032, 29.703943053233875, 29.831056633993768, 29.945378633055704, 29.995301152448477, 30.233044099329334, 30.28803438730654, 30.36941087574701, 30.62835050188855, 30.862774831946822, 31.04433970738146, 31.180941737253484, 31.367742870060056, 31.8196434296891, 31.82781002831524, 31.94521098060292, 32.2098391075498, 32.47682566029799],
              [17.081422519544954, 20.930429354855534, 22.495987438896336, 23.508722046627426, 24.116145386369695, 24.748371201480126, 25.080166381956225, 25.764453161942924, 26.40858304355184, 26.521722313698902, 26.685237378399453, 27.15152162774033, 27.562507489544316, 27.861859424464726, 28.043254711640206, 28.270374719326206, 28.49938384146138, 28.714675602355044, 28.855796229033192, 29.155278391580914, 29.382208180501372, 29.69874577348663, 29.758809897358642, 30.01377191007453, 30.137566521236273, 30.370349823736532, 30.486700802349382, 30.65957964009099, 30.99816842473952, 31.148874714881376, 31.335355019376095, 31.590461829016466, 31.65864135514572, 31.68514892697387, 31.783793058625655, 31.901990828618587, 32.018771731819406, 32.12265952742932, 32.167248697395884, 32.533657107350514, 32.70042385767249, 32.85315673666308, 32.98424704051121, 33.04504767123203, 33.10568359582831, 33.308075344790325, 33.3407002149317, 33.39220758253199, 33.51741197297106],
              [18.544853112859187, 23.118003102670297, 24.630887770741296, 25.375835045602926, 25.934584355429358, 26.599177996644706, 27.229187716511635, 27.5281258405066, 27.920350833004463, 28.439763031808674, 28.87911170127063, 28.98951408336503, 29.649737197982397, 29.791193761357633, 30.07174358841165, 30.137535860945608, 30.2699500263905, 30.629355496128525, 30.82095247996174, 30.946253073351116, 30.98266877093669, 31.09338964457676, 31.3232224229192, 31.658381860886685, 31.890766747808186, 32.00773848391356, 32.11477181930753, 32.20190363747808, 32.3470671267081, 32.39524784763192, 32.42331822529245, 32.53777812880667, 32.66230624366983, 32.76341569744372, 32.79216152436423, 33.006675866460895, 33.195235339176506, 33.46927576406183, 33.55063014969546, 33.77016105007242, 34.0601546655581, 34.302492040150284, 34.641614185611175, 35.28008512817617, 35.36301414260284, 35.47088942275063, 35.636260945094676, 36.22634180126529, 36.55793978114847],
              [20.7101723455459, 24.3552655828981, 25.92219964821251, 26.76902194101644, 27.399538146014507, 28.252579002295256, 28.696683512952568, 29.20778013904737, 29.680561301746227, 29.94685433032635, 30.283049130053037, 30.47242159545664, 30.679994730951012, 30.847029230641304, 30.999366764989798, 31.191278836747777, 31.509520158746383, 31.726324849449355, 31.902307223753468, 32.21150891232236, 32.35261905798146, 32.521184818895634, 32.70223997338315, 32.918829749448825, 33.28725904915505, 33.46913303847292, 33.81795229854873, 33.83494604305044, 34.054733891420646, 34.26096905596704, 34.65157233627045, 34.696117797109956, 34.85444533748534, 35.0749481288312, 35.205063351405485, 35.594418642066486, 35.86768766851169, 35.94757033256472, 36.30546499757902, 36.46321627208997, 36.71509035058733, 36.89593875108192, 37.12528406447186, 37.156218782285436, 37.64599750522705, 38.054077552089794, 38.15630539496037, 38.50015179466734, 38.67867412577911],
              [21.677962928858246, 25.66971092816903, 27.746486170262287, 28.661987893523687, 29.350790389187313, 29.737923372377253, 30.17311065783879, 30.620406954062368, 31.081053735265904, 31.351609132692552, 31.746169175403033, 31.833703809480685, 31.92155991136384, 32.058203522295656, 32.2814964198257, 32.55585008813613, 32.73153163342238, 32.951827283987754, 33.250415780470156, 33.58544057602424, 33.655884567221165, 33.94754213556233, 34.18941983098115, 34.440594291782915, 34.62068122287997, 34.67229818199729, 34.70739019592562, 34.715232657012976, 34.950881561148066, 35.075262156899775, 35.11994905428997, 35.290115944019526, 35.3491764382935, 35.4464458186539, 35.85975046934441, 36.31344358256423, 36.714988965201194, 36.737281745855405, 36.87389583587225, 36.940474939828675, 37.075536184037674, 37.45763213600833, 37.703572834125, 37.94642084836234, 38.1030506889286, 38.29442912711362, 38.88204082619715, 39.14224375885485, 39.50410602047627],
              [21.669718120844117, 26.801023163280085, 28.647626932373754, 29.927543482040885, 31.022133750917696, 31.407808880975672, 31.97522062629934, 32.408700278538845, 32.61893511803118, 33.06145428010934, 33.347731944527325, 33.37021786122704, 33.566408146541846, 33.721768188430175, 34.06141635081175, 34.19684878137002, 34.43730657129377, 34.68096141087751, 35.014712517356486, 35.119438500144135, 35.346798388128946, 35.505921282209044, 35.70971010272813, 36.03068776860877, 36.1433819965017, 36.25910812011057, 36.357651243340726, 36.468159259580666, 36.55754538602983, 36.71236434002747, 36.84698744880818, 36.88228517836133, 36.99338070850547, 37.537006373969774, 37.82054238540623, 38.18815336531264, 38.39193263852878, 38.455819002138306, 38.68224354429779, 38.90295858873873, 39.2010919422636, 39.41397495882334, 39.53553004882637, 39.61764157592034, 40.076077937783346, 40.21585484686049, 40.25030784652128, 40.43118408507128, 40.67747155550623],
              [23.78032531291432, 28.348312148917227, 30.498457739047883, 31.67104104282582, 33.045705354431554, 33.744111810345494, 33.88954555515767, 34.38953029923384, 34.98380593291919, 35.23910035160948, 35.65851044976611, 36.02742249290458, 36.24269267133833, 36.4956078277356, 36.836683885538015, 37.06376977853047, 37.261166219689166, 37.41005743899606, 37.61204949033024, 37.714742183557696, 38.026694772924664, 38.09526145119614, 38.279229467653906, 38.33334645745264, 38.485375916595245, 38.673469802180236, 38.96846270875956, 39.08423498550276, 39.1698256990897, 39.30375400141318, 39.72743044929388, 39.82853553758989, 39.88907419598748, 39.9771204417996, 40.09727814140082, 40.21424668103948, 40.567806228465365, 40.78140165997365, 40.97871696190402, 41.2138488857481, 41.3390433623196, 41.432549654673025, 42.01826568789939, 42.19260246637448, 42.398724475599636, 42.54178636767506, 42.82170667505242, 43.269605381341044, 43.34188313093475],
              [23.662014714646844, 28.564028789023144, 30.866515317519124, 32.18738630241939, 32.801966693278935, 33.65910205081425, 34.35971758541725, 35.18954096281516, 35.3672531554909, 35.63897439725729, 35.8599675409222, 36.440593244411815, 36.77158788194204, 37.00893294752143, 37.1725839362965, 37.36621322709934, 37.51668053710776, 37.717106122389936, 37.829735768574935, 38.046211758550996, 38.10930426016293, 38.21215457782225, 38.497611895567005, 38.620496268120455, 38.837350660759355, 39.045507462388365, 39.21830360054008, 39.60596588002251, 39.81425554359849, 40.040986748861485, 40.237310480509166, 40.49572939364413, 40.825282284388884, 40.98108306118668, 41.09476595930264, 41.139115801827444, 41.258662628814946, 41.673388601981756, 41.711871168948235, 42.08198162636752, 42.209223056336235, 42.459724906635756, 42.49390058146347, 42.580527237164446, 42.723409585582985, 42.73248671278117, 42.91326056069465, 43.49172921328275, 43.8316165517967],
              [24.142656748679435, 30.304864415734066, 32.24794443069686, 33.19446048827819, 34.41690863043012, 35.39343653001959, 35.73720028190881, 36.24940761485074, 36.725623951847545, 36.94777142343283, 37.155471473940736, 37.56882767702742, 37.91608583256157, 38.1927850004111, 38.66829336897752, 38.84237633256768, 38.94888146586157, 39.10584577771132, 39.362644264415195, 39.55440359179744, 40.076953896262125, 40.15962798169923, 40.49078849118353, 40.528307073648804, 40.896217393333124, 41.35693297071641, 41.59427006206961, 41.71133620706395, 41.84421822476277, 42.045667689388075, 42.058108424249404, 42.13489878105542, 42.420328479238236, 42.50258468230292, 42.600979349390066, 42.75114474453992, 42.81406637285783, 42.90598067828701, 43.02368015143779, 43.313899277637574, 43.40176976545274, 43.74208599605937, 43.8163589785701, 44.143682373991034, 44.43714672658767, 44.62673720867299, 44.71908806342899, 44.92822097599134, 45.00879785506577],
              [23.486189721418572, 31.3076212452119, 33.30500537651575, 34.9401765236671, 36.67617789428284, 37.331528701306695, 37.726911128444534, 38.21567277202262, 39.090972208547534, 39.19139099245045, 39.51360813836983, 40.11321846106087, 40.309746589925254, 40.592337264725614, 40.78586557882447, 41.09441866170204, 41.24886081354236, 41.36318560300545, 41.49678154245678, 41.66200839494614, 41.778846269818885, 41.82604672953377, 42.06281186293586, 42.1587210996627, 42.483453658429426, 42.60166379148514, 42.7773672906315, 42.92377050761199, 43.14269985033091, 43.3159361360473, 43.458033111279505, 43.840479253975346, 43.98351685925707, 44.373973180409564, 44.471965761473015, 44.69886237790324, 44.77857520514499, 44.98412737072728, 45.17695675525894, 45.24236331325753, 45.32609632457729, 45.82311136403052, 46.017853905347195, 46.30298129373725, 46.4482018496332, 46.63128964942181, 47.25830087690146, 47.9327723618662, 48.25108684739017],
              [24.521148868747538, 33.795660823124976, 35.57689433673366, 36.97109040390552, 37.91564503949121, 38.83154731504673, 39.260675702239745, 39.95279406865228, 40.412591620342624, 40.537305330084735, 41.10351703672898, 41.63441833283143, 42.14013255408824, 42.21226616101486, 42.71588211826394, 43.01993716723328, 43.199643223488636, 43.28185040795113, 43.47970637978017, 43.67911264675616, 43.71152948479257, 43.823325692163486, 43.88422242260153, 44.03551210171214, 44.258882296798205, 44.479314454456066, 44.72363245663782, 44.765958030821636, 44.88086069459008, 44.950858972240354, 45.332914321546504, 45.768705104757856, 46.52720062506343, 46.647350927249924, 46.78643944004222, 46.89838060662365, 46.961138514052074, 47.164751683015425, 47.178290426497064, 47.22830162463378, 47.37124497500117, 47.71200274000866, 48.275099411791274, 48.55108074423691, 48.75622989235825, 49.339533949914994, 49.60858472497904, 50.14898307476087, 50.325858640531216]
              ][n-2][k-1]
        if k == 48:
            h = h_type
        
        # Calculate matrices
        R = compute_recursive_residuals(cluster_trans)
        U = transform_to_U(R)
        M = calc_M(U, Lambda)
        T2_list, lim_list = calc_T2_and_limits(M, Lambda, h)
        
 
        # Check if UCL has been exceeded
        count = 0
        state = []
        for x,y in zip(T2_list, lim_list):
            
            if x > y:
                state.append("OOC")
                count += 1
            else:
                state.append("IC")
       
        # Fill dictionary with results
        result_df[index] = {"Norm" : T2_list, "Limit" : lim_list, "Num_OOC": count, "state": state, "h": h}
        index += 1

    return result_df



