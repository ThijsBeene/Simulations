# -*- coding: utf-8 -*-
"""
Created on Mon Dec 16 09:19:22 2024

@author: tbeene
"""

from scipy.linalg import qr, solve_triangular
import numpy as np 
import pandas as pd 
from scipy.special import stdtr # Inverse CDF of Student's t-distribution 
from scipy.stats import norm 
from numpy import linalg as LA 
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.stats import norm, t
from numpy.linalg import cholesky, inv



# ---- STEP 1: LOAD DATA ----
def generate_multivariate_data(cov, data, run_length):
    """ Generate synthetic multivariate normal data. """
    means = np.mean(data, axis=0)
    samples = np.random.multivariate_normal(mean=means, cov=cov, size=run_length)
    return pd.DataFrame(samples, columns=data.columns)


def compute_recursive_residuals(X): 
    """ 
    Compute the recursive residuals matrix R using QR factorization, following the approach in Hawkins (2007). 
    """ 
    X = np.array(X, dtype=np.float64)
    n, p = X.shape 
    R = np.full((n, p), np.nan) # Initialize R with NaNs 
    X = np.hstack((np.ones((n, 1)), X)) # Add intercept column 
    for j in range(1, p+1): # Loop over each variable 
        for i in range(j, n): # Start from the second available observation 
            # Define the regression dataset 
            y = X[:i, j] # Current target variable (column j) 
            y_act = X[i, j] # Actual value for current observation 
            # QR factorization instead of Cholesky 
            Q, R_qr = qr(X[:i, :j], mode='economic') # Compute QR decomposition 
            beta = solve_triangular(R_qr, Q.T @ y, lower = False) # Solve for regression coefficients 
         
            y_pred = X[i, :j] @ beta # Compute predicted value 
            residual = y_act - y_pred # Compute residual 
           
            # Compute leverage using QR 
            if np.linalg.det(X[:i, :j].T @ X[:i, :j]) != 0:
                h_ij = X[i, :j] @ np.linalg.inv(X[:i, :j].T @ X[:i, :j]) @ X[i, :j]
            else:
                h_ij = 0
            # Normalize recursive residual 
            R[i, j-1] = residual / np.sqrt(1 + h_ij) 
            
    # R[5][4] = -0.002
    return R 

def transform_to_U(R):
    """
    Transform a matrix of recursive residual t-statistics into independent standard normal variates.
    
    For each valid element R[i, j] (with i > j), we assume the degrees of freedom is:
         df = i - j - 1
    and define the corresponding standard normal variate as:
         u = norm.ppf( t.cdf(R[i,j], df) ).
    
    Parameters:
        R (numpy.ndarray): 2D array of recursive residual t-statistics.
                           (Entries with i <= j are not defined.)
    
    Returns:
        U (numpy.ndarray): 2D array of the same shape as R containing the transformed
                           standard normal variates.
    """
    U = np.full(R.shape, np.nan)
    n, p = R.shape
    for j in range(p):
        for i in range(j+1,n):
            # Only compute for defined residuals, i.e. i > j
            df = i - j - 1 # degrees of freedom according to the paper
            # Only transform if df > 0 (i.e. at least 3 observations in the regression)
            if df > 0:
                t_n_i = R[i, j]/np.sqrt(np.sum((R[j+1:i, j]**2)/(df)))
                # Compute the cumulative probability of the t-statistic
                p_val = t.cdf(t_n_i, df)
                # Transform to the corresponding quantile of the standard normal
                U[i, j] = norm.ppf(p_val)
               
    return U

def calc_M(U, Lambda):
    """ Compute EWMA statistic. """
    U[np.isnan(U)] = 0
    o, p = U.shape
    M_list = np.zeros_like(U)
    for n in range(0, len(U)):
        if n >= p+1:
            M_list[n] = Lambda * U[n] + (1 - Lambda) * M_list[n-1]
    return M_list

def calc_T2_and_limits(M, Lambda, h):
    """ Compute TÂ² statistics and corresponding control limits. """
    T2_list = []
    lim_list = []
    o, p = M.shape


    for n in range(0, len(M)):
        if n >= p+1:
            T2 = np.linalg.norm(M[n])**2
            T2_list.append(T2)

           
            limit = (Lambda * (1 - (1 - Lambda)**(2 * (n - p + 1))) / (2 - Lambda)) * h
            lim_list.append(limit)
        else:
            T2_list.append(0)
        
            

            lim_list.append(0)


    
    return T2_list, lim_list

def Calculate_SSEWMA_Norm_Lim(cluster_data, h_type=0):
    
    index = 0
    result_df = pd.DataFrame()
    
    k = len(cluster_data)

 
    
    for key, cluster in cluster_data.items():
        
        cluster_trans = cluster.copy().T
        columns = cluster.columns
       
        
        T2_list_clusters = []
        lim_list_clusters = []


        n = len(cluster)
        i = len(cluster.columns)
        
    
    
        Lambda = 0.25
        
        # # Automatically select the correct h value based on cluster size
        # # All h values were numerically calculated
        # if h_type == 0: 
        #     # n =2 should take the first index!
        #     # We only need to calculate values for the correct cluster sizes: [2,3,4,6,8,12,16,24]
        #     #13.649
        #     h = [8.458, 16.89649380064578, 19.11307414515445, 0, 19.10034322781972, 0, 21.626838074046063, 0, 0, 0, 25.9248817166399, 0, 0, 0, 29.485050851641205, 0, 0, 0, 0, 0, 0, 0, 32.003116528766135][n-2]
        #     # # Remove this!!!!!!
        #     # h = h_type
        # else:
        
          
        if k - 1 > 48:
            
            k = 48
            
        if n - 2 > 18:
            h = 100
        else:
            
            h = h_type*[[5.427072890045065, 6.966775383254869, 7.532793465730381, 8.469547675176265, 8.919805303010648, 9.258898379741444, 9.599875881884447, 9.819860892134198, 9.90563017440815, 10.131457025675749, 10.446073904004479, 10.59677686828109, 10.779150226867197, 10.896698712145685, 11.015661905808114, 11.088717257964642, 11.228450983506528, 11.316706926898446, 11.453532793305452, 11.59975235699077, 11.748227111254764, 11.776020563453159, 11.863607723062483, 11.971883960777168, 12.081320390118872, 12.242165927948644, 12.351054903968791, 12.362068617097158, 12.42941392685308, 12.505121023640458, 12.595249793194291, 12.807261289313708, 12.923143366493036, 12.979468433629862, 13.024631075774813, 13.069649297167295, 13.085188673449096, 13.16683291461402, 13.189153745405953, 13.219045237197577, 13.291864082180972, 13.291864082181778, 13.34363861951232, 13.53541980736775, 13.623930834339383, 13.666963677629763, 13.703067838883136, 13.741216576494956, 13.77166312458758],
              [7.053243036270425, 9.033801814549703, 10.091952921417182, 10.786901341956188, 11.294255398630767, 11.685841574855644, 11.955117454261092, 12.212103067735914, 12.424431486081868, 12.594929080490205, 12.893429121203283, 13.139920558148264, 13.279913593934154, 13.514537917190008, 13.60293387834689, 13.71291029567086, 13.799021809240365, 13.880067867294073, 14.011103639238131, 14.089825203946848, 14.156559172525787, 14.313813310028014, 14.38743915394184, 14.481608225123233, 14.65943785777412, 14.749806590346779, 14.82883348064973, 14.886288111179795, 15.003356390639077, 15.096055201898736, 15.197357374104813, 15.248034895758824, 15.396919578028845, 15.463285732598896, 15.61637525786362, 15.791841784405717, 15.90080252435539, 15.968657942896716, 16.08484410270704, 16.110033959742196, 16.153836949152627, 16.20189453377212, 16.45401947866729, 16.540735395631575, 16.607377411346732, 16.644596592837495, 16.808137558778952, 16.89649380064578, 16.94202721897458],
              [8.422517912489761, 10.558956648955677, 11.800987171302786, 12.391947261570149, 12.936408447755472, 13.497210907077985, 13.934650336975347, 14.167574493104778, 14.590042501838937, 14.82035913645929, 14.963159211994652, 15.128367736543474, 15.327471578611743, 15.540647760548563, 15.657139393238571, 15.924932111040027, 16.015638646810622, 16.108305921819866, 16.286439704864385, 16.41493204094397, 16.575333631052196, 16.649804803707866, 16.766935865732783, 16.815013736589062, 16.847986337798936, 16.909873360781088, 16.99096137821702, 17.126451991613873, 17.263134157075825, 17.334113555486375, 17.41852062429698, 17.491944450075053, 17.615947699169343, 17.684362668588825, 17.82857342775224, 17.888993675826658, 18.035089510986364, 18.08106778002383, 18.11738526691074, 18.231755341479673, 18.30327806368311, 18.505237035229797, 18.588697451323455, 18.648705461625266, 18.778375917545567, 18.881782578226947, 18.931753173447973, 19.11307414515445, 19.217835469504216],
              [10.091203799292181, 12.285153883613408, 13.552867034289143, 14.224164673388746, 14.841032525345389, 15.453663175434457, 15.930617945346587, 16.34509238082946, 16.647667381215715, 16.835951120306774, 17.215681231537857, 17.40804505627773, 17.639337056777343, 17.767195551581587, 17.950330192941674, 18.110030796774467, 18.20827594441542, 18.340684320131007, 18.51514802298008, 18.705247132946536, 18.814681155636837, 18.963588454033545, 19.018416159758857, 19.160967040983603, 19.26028898992913, 19.351690662730164, 19.420608584766192, 19.49901582041104, 19.715489548039407, 19.889695567167408, 19.97538989148108, 20.02707603812386, 20.127379583881332, 20.19376778104312, 20.32366076190777, 20.447305653294542, 20.550248397999976, 20.656358593170374, 20.721726452323423, 20.81171891469005, 20.92439527325067, 21.00207053399148, 21.063346655941196, 21.14943759851839, 21.222130455383983, 21.2962061570001, 21.313815932536652, 21.45990814268989, 21.48526074565866],
              [11.983309257182935, 14.318441702148018, 15.64453867257947, 16.297485869968437, 17.210478679418593, 17.423202899880707, 17.776601842816948, 18.129599426098814, 18.35195407278602, 18.571766531142984, 18.849811320569028, 19.276912361470572, 19.480026349617027, 19.802714277806203, 19.870974885497787, 20.04507946309331, 20.101145573349143, 20.298686509923975, 20.539714473271406, 20.627450448500362, 20.778476195339955, 20.82931908950612, 20.939516620550208, 21.03298549972921, 21.147575635244664, 21.321899586860546, 21.411617975093513, 21.55116778424751, 21.61080511512187, 21.71844748122618, 21.82126300464071, 21.954151362845806, 22.018417995224908, 22.05441156541566, 22.13039262132812, 22.249332538270654, 22.321014632014453, 22.45577479820097, 22.500522623910264, 22.60261144635625, 22.691745720903864, 22.743164680417987, 22.83201617995431, 22.956399810536, 23.03387462159301, 23.17302860073759, 23.26237563792108, 23.37120854830278, 23.39898103940899],
              [12.954917187324934, 15.49167121233604, 16.858676521040422, 17.879773357558484, 18.384639328866776, 18.782849730016608, 19.13524133674842, 19.718885685897305, 20.020995846238645, 20.244906711022768, 20.57475394455182, 20.784079464193795, 21.029372473007946, 21.184739173141683, 21.348548158151704, 21.48253680932305, 21.630143808717328, 21.845398372675835, 21.9845752232394, 22.09910288624943, 22.186506692599494, 22.505842364358475, 22.632184214815062, 22.714392741477635, 22.776470764405104, 22.93084211364257, 23.07324767240027, 23.209629799607974, 23.26964331749399, 23.432271380030784, 23.633334021828112, 23.65522199607591, 23.712751602067, 23.755598420656376, 23.86754624707013, 23.995110129048008, 24.11844724531202, 24.199221135393746, 24.264633570592075, 24.36500105500278, 24.438130271918418, 24.514420943456653, 24.641331428796, 24.728157167400706, 24.782106442776843, 24.876826026918796, 24.955039055530047, 25.021519562453665, 25.040690161750447],
              [14.962509249427958, 17.645309010737197, 18.85523297398013, 19.547554724412535, 20.129993673338515, 20.817967075117384, 21.062908807797367, 21.317207204667408, 21.583599346362156, 21.90441850670144, 22.331577253317555, 22.543593998629316, 22.808569518222033, 22.95384236416018, 23.160603014245197, 23.460147292280396, 23.60520451808725, 23.72814896825495, 23.884073222529043, 24.109134912452028, 24.289873043144922, 24.38883989176927, 24.547819714249712, 24.714052164812802, 24.743148644640073, 24.806204463021533, 24.966187055615602, 25.051317722337522, 25.22278654389362, 25.28341184289227, 25.356807577221556, 25.43124862256552, 25.570059283596148, 25.710768475250156, 25.891820177735124, 26.046745715706667, 26.158795526995206, 26.22666516050814, 26.369957433351008, 26.39532852174904, 26.563527529084723, 26.612189254651017, 26.78417234053316, 26.907271181279647, 27.021356792685495, 27.10285136558967, 27.215270642154476, 27.318707590149586, 27.418549426938704],
              [15.225648436623596, 18.00385346193954, 19.434653327200515, 20.243330918392655, 20.960372165844866, 21.550167491444935, 22.09917228651155, 22.678035451634614, 22.799090336478233, 23.183788071916005, 23.61283770990451, 24.015763249730462, 24.28595137421441, 24.404486509488517, 24.58802803110157, 24.73268641819939, 24.9199340430922, 25.0579869318923, 25.229665689116498, 25.421907685225108, 25.65671995603002, 25.805560170952077, 26.00119072877928, 26.082757381131355, 26.349027706055246, 26.436667564766537, 26.547352760916585, 26.687945186910024, 26.72420944726307, 26.975004274704528, 27.123498704710023, 27.22349137946798, 27.271269396747787, 27.589362823583883, 27.86670570934018, 28.011185906997383, 28.327305049467853, 28.361972618566153, 28.47947814604638, 28.676435458851653, 28.858339115091315, 29.14479257681831, 29.336014928316366, 29.35638419918879, 29.585967531166897, 29.92549444373104, 30.474596413794956, 30.576148100627, 30.938576688209896],
              [16.773283005087748, 20.417989835731724, 21.724474110330778, 22.51132048154107, 23.572734458890167, 24.279558623653703, 24.832562100073496, 25.099299519188236, 25.150466637646915, 25.35016553593339, 25.63398355841207, 25.872017040262378, 26.084736128892207, 26.565661058498485, 26.82302448408219, 27.05799897858244, 27.381894718876563, 27.46598143073275, 27.74154882967508, 27.843930156592876, 28.038208820081188, 28.319662590186375, 28.411434673131115, 28.49236606673665, 28.65744118131128, 28.903722092416366, 29.13124150886589, 29.2471847753689, 29.341397850314983, 29.45921114509415, 29.596416989936486, 29.60563016930032, 29.703943053233875, 29.831056633993768, 29.945378633055704, 29.995301152448477, 30.233044099329334, 30.28803438730654, 30.36941087574701, 30.62835050188855, 30.862774831946822, 31.04433970738146, 31.180941737253484, 31.367742870060056, 31.8196434296891, 31.82781002831524, 31.94521098060292, 32.2098391075498, 32.47682566029799],
              [17.081422519544954, 20.930429354855534, 22.495987438896336, 23.508722046627426, 24.116145386369695, 24.748371201480126, 25.080166381956225, 25.764453161942924, 26.40858304355184, 26.521722313698902, 26.685237378399453, 27.15152162774033, 27.562507489544316, 27.861859424464726, 28.043254711640206, 28.270374719326206, 28.49938384146138, 28.714675602355044, 28.855796229033192, 29.155278391580914, 29.382208180501372, 29.69874577348663, 29.758809897358642, 30.01377191007453, 30.137566521236273, 30.370349823736532, 30.486700802349382, 30.65957964009099, 30.99816842473952, 31.148874714881376, 31.335355019376095, 31.590461829016466, 31.65864135514572, 31.68514892697387, 31.783793058625655, 31.901990828618587, 32.018771731819406, 32.12265952742932, 32.167248697395884, 32.533657107350514, 32.70042385767249, 32.85315673666308, 32.98424704051121, 33.04504767123203, 33.10568359582831, 33.308075344790325, 33.3407002149317, 33.39220758253199, 33.51741197297106],
              [18.544853112859187, 23.118003102670297, 24.630887770741296, 25.375835045602926, 25.934584355429358, 26.599177996644706, 27.229187716511635, 27.5281258405066, 27.920350833004463, 28.439763031808674, 28.87911170127063, 28.98951408336503, 29.649737197982397, 29.791193761357633, 30.07174358841165, 30.137535860945608, 30.2699500263905, 30.629355496128525, 30.82095247996174, 30.946253073351116, 30.98266877093669, 31.09338964457676, 31.3232224229192, 31.658381860886685, 31.890766747808186, 32.00773848391356, 32.11477181930753, 32.20190363747808, 32.3470671267081, 32.39524784763192, 32.42331822529245, 32.53777812880667, 32.66230624366983, 32.76341569744372, 32.79216152436423, 33.006675866460895, 33.195235339176506, 33.46927576406183, 33.55063014969546, 33.77016105007242, 34.0601546655581, 34.302492040150284, 34.641614185611175, 35.28008512817617, 35.36301414260284, 35.47088942275063, 35.636260945094676, 36.22634180126529, 36.55793978114847],
              [20.7101723455459, 24.3552655828981, 25.92219964821251, 26.76902194101644, 27.399538146014507, 28.252579002295256, 28.696683512952568, 29.20778013904737, 29.680561301746227, 29.94685433032635, 30.283049130053037, 30.47242159545664, 30.679994730951012, 30.847029230641304, 30.999366764989798, 31.191278836747777, 31.509520158746383, 31.726324849449355, 31.902307223753468, 32.21150891232236, 32.35261905798146, 32.521184818895634, 32.70223997338315, 32.918829749448825, 33.28725904915505, 33.46913303847292, 33.81795229854873, 33.83494604305044, 34.054733891420646, 34.26096905596704, 34.65157233627045, 34.696117797109956, 34.85444533748534, 35.0749481288312, 35.205063351405485, 35.594418642066486, 35.86768766851169, 35.94757033256472, 36.30546499757902, 36.46321627208997, 36.71509035058733, 36.89593875108192, 37.12528406447186, 37.156218782285436, 37.64599750522705, 38.054077552089794, 38.15630539496037, 38.50015179466734, 38.67867412577911],
              [21.677962928858246, 25.66971092816903, 27.746486170262287, 28.661987893523687, 29.350790389187313, 29.737923372377253, 30.17311065783879, 30.620406954062368, 31.081053735265904, 31.351609132692552, 31.746169175403033, 31.833703809480685, 31.92155991136384, 32.058203522295656, 32.2814964198257, 32.55585008813613, 32.73153163342238, 32.951827283987754, 33.250415780470156, 33.58544057602424, 33.655884567221165, 33.94754213556233, 34.18941983098115, 34.440594291782915, 34.62068122287997, 34.67229818199729, 34.70739019592562, 34.715232657012976, 34.950881561148066, 35.075262156899775, 35.11994905428997, 35.290115944019526, 35.3491764382935, 35.4464458186539, 35.85975046934441, 36.31344358256423, 36.714988965201194, 36.737281745855405, 36.87389583587225, 36.940474939828675, 37.075536184037674, 37.45763213600833, 37.703572834125, 37.94642084836234, 38.1030506889286, 38.29442912711362, 38.88204082619715, 39.14224375885485, 39.50410602047627],
              [21.669718120844117, 26.801023163280085, 28.647626932373754, 29.927543482040885, 31.022133750917696, 31.407808880975672, 31.97522062629934, 32.408700278538845, 32.61893511803118, 33.06145428010934, 33.347731944527325, 33.37021786122704, 33.566408146541846, 33.721768188430175, 34.06141635081175, 34.19684878137002, 34.43730657129377, 34.68096141087751, 35.014712517356486, 35.119438500144135, 35.346798388128946, 35.505921282209044, 35.70971010272813, 36.03068776860877, 36.1433819965017, 36.25910812011057, 36.357651243340726, 36.468159259580666, 36.55754538602983, 36.71236434002747, 36.84698744880818, 36.88228517836133, 36.99338070850547, 37.537006373969774, 37.82054238540623, 38.18815336531264, 38.39193263852878, 38.455819002138306, 38.68224354429779, 38.90295858873873, 39.2010919422636, 39.41397495882334, 39.53553004882637, 39.61764157592034, 40.076077937783346, 40.21585484686049, 40.25030784652128, 40.43118408507128, 40.67747155550623],
              [23.78032531291432, 28.348312148917227, 30.498457739047883, 31.67104104282582, 33.045705354431554, 33.744111810345494, 33.88954555515767, 34.38953029923384, 34.98380593291919, 35.23910035160948, 35.65851044976611, 36.02742249290458, 36.24269267133833, 36.4956078277356, 36.836683885538015, 37.06376977853047, 37.261166219689166, 37.41005743899606, 37.61204949033024, 37.714742183557696, 38.026694772924664, 38.09526145119614, 38.279229467653906, 38.33334645745264, 38.485375916595245, 38.673469802180236, 38.96846270875956, 39.08423498550276, 39.1698256990897, 39.30375400141318, 39.72743044929388, 39.82853553758989, 39.88907419598748, 39.9771204417996, 40.09727814140082, 40.21424668103948, 40.567806228465365, 40.78140165997365, 40.97871696190402, 41.2138488857481, 41.3390433623196, 41.432549654673025, 42.01826568789939, 42.19260246637448, 42.398724475599636, 42.54178636767506, 42.82170667505242, 43.269605381341044, 43.34188313093475],
              [23.662014714646844, 28.564028789023144, 30.866515317519124, 32.18738630241939, 32.801966693278935, 33.65910205081425, 34.35971758541725, 35.18954096281516, 35.3672531554909, 35.63897439725729, 35.8599675409222, 36.440593244411815, 36.77158788194204, 37.00893294752143, 37.1725839362965, 37.36621322709934, 37.51668053710776, 37.717106122389936, 37.829735768574935, 38.046211758550996, 38.10930426016293, 38.21215457782225, 38.497611895567005, 38.620496268120455, 38.837350660759355, 39.045507462388365, 39.21830360054008, 39.60596588002251, 39.81425554359849, 40.040986748861485, 40.237310480509166, 40.49572939364413, 40.825282284388884, 40.98108306118668, 41.09476595930264, 41.139115801827444, 41.258662628814946, 41.673388601981756, 41.711871168948235, 42.08198162636752, 42.209223056336235, 42.459724906635756, 42.49390058146347, 42.580527237164446, 42.723409585582985, 42.73248671278117, 42.91326056069465, 43.49172921328275, 43.8316165517967],
              [24.142656748679435, 30.304864415734066, 32.24794443069686, 33.19446048827819, 34.41690863043012, 35.39343653001959, 35.73720028190881, 36.24940761485074, 36.725623951847545, 36.94777142343283, 37.155471473940736, 37.56882767702742, 37.91608583256157, 38.1927850004111, 38.66829336897752, 38.84237633256768, 38.94888146586157, 39.10584577771132, 39.362644264415195, 39.55440359179744, 40.076953896262125, 40.15962798169923, 40.49078849118353, 40.528307073648804, 40.896217393333124, 41.35693297071641, 41.59427006206961, 41.71133620706395, 41.84421822476277, 42.045667689388075, 42.058108424249404, 42.13489878105542, 42.420328479238236, 42.50258468230292, 42.600979349390066, 42.75114474453992, 42.81406637285783, 42.90598067828701, 43.02368015143779, 43.313899277637574, 43.40176976545274, 43.74208599605937, 43.8163589785701, 44.143682373991034, 44.43714672658767, 44.62673720867299, 44.71908806342899, 44.92822097599134, 45.00879785506577],
              [23.486189721418572, 31.3076212452119, 33.30500537651575, 34.9401765236671, 36.67617789428284, 37.331528701306695, 37.726911128444534, 38.21567277202262, 39.090972208547534, 39.19139099245045, 39.51360813836983, 40.11321846106087, 40.309746589925254, 40.592337264725614, 40.78586557882447, 41.09441866170204, 41.24886081354236, 41.36318560300545, 41.49678154245678, 41.66200839494614, 41.778846269818885, 41.82604672953377, 42.06281186293586, 42.1587210996627, 42.483453658429426, 42.60166379148514, 42.7773672906315, 42.92377050761199, 43.14269985033091, 43.3159361360473, 43.458033111279505, 43.840479253975346, 43.98351685925707, 44.373973180409564, 44.471965761473015, 44.69886237790324, 44.77857520514499, 44.98412737072728, 45.17695675525894, 45.24236331325753, 45.32609632457729, 45.82311136403052, 46.017853905347195, 46.30298129373725, 46.4482018496332, 46.63128964942181, 47.25830087690146, 47.9327723618662, 48.25108684739017],
              [24.521148868747538, 33.795660823124976, 35.57689433673366, 36.97109040390552, 37.91564503949121, 38.83154731504673, 39.260675702239745, 39.95279406865228, 40.412591620342624, 40.537305330084735, 41.10351703672898, 41.63441833283143, 42.14013255408824, 42.21226616101486, 42.71588211826394, 43.01993716723328, 43.199643223488636, 43.28185040795113, 43.47970637978017, 43.67911264675616, 43.71152948479257, 43.823325692163486, 43.88422242260153, 44.03551210171214, 44.258882296798205, 44.479314454456066, 44.72363245663782, 44.765958030821636, 44.88086069459008, 44.950858972240354, 45.332914321546504, 45.768705104757856, 46.52720062506343, 46.647350927249924, 46.78643944004222, 46.89838060662365, 46.961138514052074, 47.164751683015425, 47.178290426497064, 47.22830162463378, 47.37124497500117, 47.71200274000866, 48.275099411791274, 48.55108074423691, 48.75622989235825, 49.339533949914994, 49.60858472497904, 50.14898307476087, 50.325858640531216]
              ][n-2][k-1]
        

            # ARL_IC_Overall = 25
            #     #Add rows to the h matrix to increase accuracy!
            # h = [[6.267019794286084, 7.592246272702728, 8.413673018945527, 8.989513103777009, 9.41919290715257, 9.791048959348418, 10.112967444336878, 10.398617584298556, 10.646717408439326, 10.846262242520098, 11.046980909557483, 11.195921705472047, 11.355311792341139, 11.50868165494565, 11.650458719679191, 11.782148995992168, 11.91850600321797, 12.01692285951761, 12.109429241695771, 12.187534756761307, 12.295284290340197, 12.410418588462537, 12.49681181538802, 12.586856581871285, 12.652908674723532, 12.741817510212396, 12.805546925487024, 12.872801339951318, 12.931435485001739, 12.990460503101275, 13.071796122914495, 13.152405198785289, 13.21702986075509, 13.27997085264122, 13.338608021942695, 13.399946509430656, 13.466147202040514, 13.521978524450645, 13.559204989852681, 13.593169729749013, 13.638392132537923, 13.690710919191904, 13.733137610593179, 13.806731489094776, 13.863736628374152, 13.88935197155895, 13.91359135663691, 13.94544095909944, 14.008903624086441],
            #       [8.035402353920876, 9.511215453061507, 10.386533024524905, 11.006062805190142, 11.50432063875347, 11.890295863035593, 12.197610381502614, 12.471607347875477, 12.72639636067967, 12.955068079331465, 13.169791068577265, 13.379998356388471, 13.56118810278707, 13.694661686956897, 13.829528222798078, 13.971014184642563, 14.087365237962475, 14.207539091160406, 14.332543933581995, 14.431744073573697, 14.542547692171974, 14.651274120843311, 14.749803236045453, 14.87006364355118, 14.95467769434493, 15.020559094135265, 15.08496868143734, 15.156093214086527, 15.263766965366631, 15.308603090090575, 15.38921490862814, 15.46046789087439, 15.505507792951814, 15.570429016184125, 15.61181380932767, 15.706783985584664, 15.76309930570802, 15.846457208328872, 15.918104054335101, 15.998651368212197, 16.05207567356243, 16.092309504934814, 16.146811833607465, 16.222616265679743, 16.257044248777717, 16.338061820667942, 16.398246164382996, 16.452180698045936, 16.495310224128044],
            #       [9.686998330177035, 11.297839225060407, 12.241600164238585, 12.91907992391867, 13.41150740163059, 13.820949110796462, 14.152192497904649, 14.4422533581569, 14.729439558043488, 14.955073211405114, 15.154860190440768, 15.355224961484986, 15.538942402539693, 15.69669245386114, 15.877552440230984, 15.99929918652471, 16.142789421066936, 16.279322831121263, 16.39576149739504, 16.519348447352893, 16.597287427404765, 16.687381490716255, 16.77977411971078, 16.884885280745372, 16.964166642236968, 17.052048354963112, 17.129022736946077, 17.186223816402407, 17.251719671717268, 17.313088093378173, 17.416411544681125, 17.49352246501922, 17.552538303148403, 17.61939546915147, 17.682655885488302, 17.744713814769007, 17.81769166362606, 17.8752157383791, 17.931787957107332, 17.993207921836603, 18.05554540984162, 18.11949718828287, 18.15276897938398, 18.179991556854425, 18.231786227143346, 18.271426796226404, 18.28890105712601, 18.322012530703773, 18.389805127298146],
            #       [11.154645459732333, 12.859198099207202, 13.854397513681377, 14.545431335438687, 15.070658260961412, 15.51978632489002, 15.892329538358723, 16.22492964436937, 16.516534598237012, 16.780667929699078, 17.00223583987973, 17.22391042733248, 17.39218299276827, 17.545274576199787, 17.700717869308075, 17.848661835786622, 17.966621962855868, 18.108178102708393, 18.24826129417243, 18.36770694468018, 18.47255044827353, 18.577264536578454, 18.670267101621867, 18.777110614902455, 18.864784247757097, 18.946246271943192, 19.01295521081071, 19.11326288380006, 19.19008894214765, 19.268415037965127, 19.338651156615626, 19.40176309147031, 19.450442672250077, 19.530276153360795, 19.60185718913952, 19.664543330782365, 19.731861421227343, 19.801154955124485, 19.845499945324658, 19.88260709692903, 19.945115937208435, 20.012419728372024, 20.076961509821516, 20.10372777592644, 20.169922770679626, 20.212593480229163, 20.27984109273274, 20.359249753385754, 20.40370066597241],
            #       [12.63079092667823, 14.415373054932186, 15.460927650561933, 16.191719088867398, 16.78124022710452, 17.246807669878223, 17.608907575427267, 17.952021979470544, 18.24479634518559, 18.496230254442985, 18.742932034971915, 18.96662819234116, 19.17501627356741, 19.37814151928417, 19.517631534775795, 19.67620966164986, 19.816072004712737, 19.97083997125751, 20.101015774645763, 20.20133114699914, 20.31827377215972, 20.474545928323067, 20.57242143927706, 20.681434070414614, 20.785669558935894, 20.86781913537397, 20.985254381141004, 21.072468718928352, 21.227039440582548, 21.363055976433948, 21.467988300394364, 21.550541761801682, 21.59842358101055, 21.665948777053462, 21.72575308579882, 21.806461027482626, 21.88169808232578, 21.92388900156868, 21.95909263260732, 22.010319625069158, 22.095116828746082, 22.168671906166637, 22.190088475611528, 22.27895188383085, 22.32766677067849, 22.402380171802818, 22.44063663221074, 22.49227236123122, 22.576042780818376],
            #       [14.101388251901483, 15.989511656931358, 17.072806341839833, 17.87276687577111, 18.45202026674103, 18.946539286936563, 19.357104404104447, 19.70311604692047, 20.03490511789808, 20.26946037515703, 20.53526355885623, 20.72023226629487, 20.948812686673246, 21.160558649661418, 21.32249268792438, 21.489505789622495, 21.650143261501675, 21.763498704371948, 21.882082396015207, 22.024095269642633, 22.140280696061538, 22.248065967669405, 22.36174406066705, 22.45170660031144, 22.581002674311584, 22.67920547369063, 22.759713968245148, 22.88002111535614, 22.955223072720134, 23.035761010229947, 23.126740575694335, 23.176301813255137, 23.25017286610582, 23.377494214452504, 23.451679005257745, 23.51080134354604, 23.560602536350217, 23.636695318578745, 23.731829421922377, 23.776598089397297, 23.839304181996532, 23.910494742798733, 23.987167516653784, 24.03517915495693, 24.126683730089336, 24.199340743026678, 24.26249521936822, 24.289097980257814, 24.353753166102454]
            #       ][n-2][k-1]
            
            # print(h)
                  
            # h = [[7.454015631988858, 8.821751716892113, 9.620950371328455, 10.194298805244616, 10.641891000895566, 11.005873249990941, 11.310004233404676, 11.57037042748467, 11.810389819336894, 12.016083591276889, 12.208677291227167, 12.37935981863221, 12.537012557736773, 12.682488492713489, 12.830507528834357, 12.951332569143265, 13.072344762974161, 13.182783242608608, 13.2944186488799, 13.383858285106722, 13.485412279795078, 13.59397440235518, 13.673808960920496, 13.752787037659857, 13.834235572917965, 13.918201061707187, 14.00878673501793, 14.09232552615572, 14.15285532474661], 
            #       [9.331813037272704, 10.825319853654303, 11.669903289087816, 12.274386629696842, 12.735682313156211, 13.107291532722197, 13.429803190055402, 13.711943567722296, 13.959575540242337, 14.178734229725627, 14.382974691358859, 14.562410867366085, 14.730693869138735, 14.89110527512135, 15.020811925928207, 15.171684364794583, 15.309196687073714, 15.440035720213787, 15.5688101534011, 15.66357534242318, 15.76477879122383, 15.847159732342455, 15.940775211627711, 16.01870698399133, 16.106703076392506, 16.195664118120987, 16.293926203706892, 16.362455481449622, 16.436982320498863],
            #       [10.994719760810593, 12.552773629223289, 13.472879469259528, 14.139673980997616, 14.643090801875422, 15.036340141900569, 15.385492699569333, 15.663056380589534, 15.911915200135685, 16.135057460629465, 16.335452001244814, 16.51307334732524, 16.710554792208693, 16.870981820013164, 17.0267406234493, 17.152821755040133, 17.27557285177904, 17.384028991564847, 17.490107673086257, 17.612386027338516, 17.736607024870843, 17.84416260444285, 17.898362774448483, 17.984358836268402, 18.0799451608293, 18.187231349032032, 18.28967912322795, 18.381388518721643, 18.46372499369856],
            #       [12.540404973824055, 14.25026733509068, 15.23524886963676, 15.90727345445077, 16.4369929865107, 16.889199846346077, 17.244243029120796, 17.55793088666772, 17.823096409732777, 18.05726138518547, 18.273260680087347, 18.469380217606705, 18.654758695727466, 18.822392456173382, 18.982705698835453, 19.127043609140017, 19.257796212289893, 19.38062653766447, 19.50104355041765, 19.61503943121126, 19.731902710785853, 19.805037566476187, 19.891156459440786, 19.971465529234354, 20.044413634713884, 20.109356730362652, 20.206155719743215, 20.283693351186166, 20.35152668303291], 
            #       [13.985932250107943, 15.788303873210463, 16.822942787186296, 17.540742861598112, 18.098329509413247, 18.570351637331427, 18.94745593760883, 19.25792195788578, 19.51029930724233, 19.818527091196533, 20.01969199674164, 20.221969879522284, 20.39146268463681, 20.584816379052118, 20.717242503585055, 20.848100591534, 20.975440630206037, 21.079780521609372, 21.178537952684692, 21.256743802477665, 21.36207160354102, 21.49046349937534, 21.553981138997084, 21.66126288440435, 21.718041253094917, 21.804882841136596, 21.95900098615893, 22.006534226918866, 22.035143032052133],  # Performed with 10000 from this point and including onward instead of 30000!
            #       [15.409536703110915, 17.241708096142347, 18.281107211286887, 18.996114574569724, 19.598725111451987, 20.10045460264226, 20.499068764752483, 20.85696291756644, 21.155110613051775, 21.459993596921425, 21.73862003422607, 21.97057103298315, 22.155333402763844, 22.318382621750676, 22.48758096962077, 22.64633758309462, 22.828334125562584, 22.94041440026665, 23.038547123666625, 23.192436491701592, 23.325297836566435, 23.441077339486945, 23.507216887861954, 23.637945902516353, 23.7943270878642, 23.882480389746274, 23.935585494013612, 24.032073909795187, 24.152752427717854],
            #       [16.833032333307873, 18.812029012181654, 19.912254046543715, 20.655044018862675, 21.224879989949528, 21.71986017267303, 22.11779877524253, 22.525709877205294, 22.794589829730413, 23.091993596036254, 23.311683214069916, 23.52239518712767, 23.71921492064594, 23.969965094350513, 24.125196974985162, 24.298710723394496, 24.42536887156497, 24.593392022603894, 24.710613342566383, 24.865292555793353, 25.01249941236067, 25.1631654457821, 25.256970844101385, 25.326112463649103, 25.489886719115564, 25.5479430798634, 25.608903862148903, 25.70770321248482, 25.804400424257715], 
            #       [18.126350455979058, 20.151342555012278, 21.28868619856926, 22.07442324867444, 22.66021527764386, 23.180506503011394, 23.586493826635962, 24.00704080879373, 24.310894986639855, 24.574096381800672, 24.81780253463589, 25.039149316213248, 25.2421350260879, 25.423546448120153, 25.652048758199236, 25.791092439719776, 26.023169096195538, 26.122523433499026, 26.272773995326666, 26.36677043486973, 26.52787454914847, 26.59307029635299, 26.701601002602413, 26.862221851515628, 26.969628957497708, 27.034944789038175, 27.142719525345708, 27.220038480156653, 27.249078892063768], 
            #       [19.27301661314617,21.389220520171243,22.61290397384888,23.427754204932043,24.129666886062136,24.6636747753957,25.10341044081473,25.496163861507142,25.797825524548795,26.068895205092907,26.30374915839474,26.52316353426743,26.647556093996393,26.858342343651646,27.024836164724448,27.162451983201734,27.38504306963373,27.498278956310994,27.69985824565983,27.826710884132783,27.923626004594162,28.016540573405837,28.060716111719582,28.16678823978365,28.287708099799826,28.410823417319115,28.471654137607914,28.589534152341784,28.690944119878054],  
            #       [20.436708191139797, 22.578517567278453, 23.751672826493458, 24.603448893363854, 25.293660418507116, 25.782552299128373, 26.272524450361715, 26.60367523954831, 26.83348375699884, 27.180292394059776, 27.4285075840583, 27.67694088367753, 27.936731750759463, 28.170671166807274, 28.383826804963313, 28.555101896353342, 28.773856737154713, 28.931980111551503, 29.07783567141752, 29.221558267261038, 29.311086008457135, 29.435146621791503, 29.522092834549774, 29.635848008011138, 29.74392000538738, 29.82210459205456, 29.91599751545294, 30.057288648591594, 30.202833377671023],
            #       [21.59528501343729, 23.7555073263825, 24.999903041132292, 25.807270289650475, 26.517429828365216, 27.01219620345934, 27.402513091579674, 27.74791506886102, 28.09998770770611, 28.4351761348716, 28.676832352703087, 28.933325771902794, 29.143993560078066, 29.402900243880353, 29.55370047609012, 29.725848143543953, 29.87970222861308, 30.103929635299593, 30.24149903073154, 30.380105037811905, 30.49252024750009, 30.611030239617232, 30.72808463218344, 30.843484490292216, 31.030108861685424, 31.162577725663095, 31.27254794927194, 31.402114483296295, 31.435753985345272],
            #       [22.59828475784704, 24.980265589930728, 26.326838318867654, 27.277050647124035, 27.99193680409211, 28.510162667476862, 28.96866049298653, 29.333665691970396, 29.64538449441573, 29.94060805201305, 30.18164417715177, 30.4316109488313, 30.657359217765894, 30.882672399205678, 31.06448571688444, 31.268406817060296, 31.491910429492677, 31.64860285361432, 31.746895799224436, 31.863777427501233, 31.945402288633332, 32.09831206854126, 32.18393950737377, 32.241224349630386, 32.32657650070739, 32.39143454294822, 32.47331648895348, 32.600995149420704, 32.786241782970905],
            #       [23.60717416421509, 25.935627090764484, 27.277457404664954, 28.19763911346286, 28.927860009039087, 29.535403111080427, 29.986130140775174, 30.43189632821456, 30.78113102432028, 31.129951624957506, 31.475550805605877, 31.717043799612558, 31.916240871669963, 32.13250392014111, 32.33613653705761, 32.485637865078566, 32.640307129558295, 32.822727302665314, 32.98411752771555, 33.12743174523251, 33.26616529199151, 33.38619756855577, 33.52791885933792, 33.66727356997557, 33.918568993862536, 34.03123465683347, 34.15612968700758, 34.23860070420742, 34.33389086565642],
            #       [24.822653147881457, 27.314629186752562, 28.695980845576386, 29.583729815250592, 30.307613638877122, 30.87582661273795, 31.313125857539333, 31.69805797910967, 32.00634829562293, 32.313665098684446, 32.57917185519522, 32.92099145611247, 33.133479894829755, 33.330251773374655, 33.5137829123357, 33.698460389202815, 33.85365644111782, 34.029076556184116, 34.229405623196996, 34.336081328472176, 34.4582755689233, 34.56133903741169, 34.71229160860943, 34.80806653711406, 34.954973427635515, 35.095952337798174, 35.15448665689755, 35.235152175601186, 35.31927742953064],
            #       [25.705958089892157, 28.19120899902415, 29.63995576302525, 30.70227102486341, 31.40959593744198, 31.974769060383338, 32.46409426700405, 32.8312145193455, 33.19607156782844, 33.539224117936996, 33.751191328581605, 34.047057616602984, 34.36198708058464, 34.572742704953406, 34.77553002053028, 35.02383133009441, 35.203923485128485, 35.35796205634668, 35.57009906121004, 35.73567165464807, 35.90632458550419, 36.04156943251315, 36.20013152518323, 36.30802972983543, 36.54873808498802, 36.623771376101104, 36.78526441617988, 36.91303855849306, 36.99389094742368],
            #       [26.51649885915525, 29.162268939631012, 30.658427398882502, 31.631633761522387, 32.34560912122417, 33.07847568206063, 33.60590680806792, 33.997177629226485, 34.43033234868399, 34.75160798561514, 35.107038628645164, 35.33748658831647, 35.55692574764312, 35.867117095765344, 36.185109710483, 36.43786920376412, 36.683351790708336, 36.96945124505321, 37.09798946405139, 37.23642477438737, 37.35249293514102, 37.51406731060658, 37.70239873052354, 37.82226511361514, 37.93152674456917, 38.06967792757173, 38.19100951869275, 38.254122520502726, 38.34820147223142],
            #       [27.365971712354447, 30.062837501641205, 31.532968244560593, 32.521710471684656, 33.24654439552288, 33.85889598265629, 34.452877165646996, 34.87529060767964, 35.25951291528861, 35.59130579924619, 35.972253335699556, 36.29202073727497, 36.56294461617311, 36.7293989884581, 36.935120477627606, 37.148683149538215, 37.330020961416885, 37.475256915236024, 37.609976555367645, 37.74982687546727, 37.89167478422827, 37.992065109564734, 38.11963333004506, 38.21112912166372, 38.329288067657345, 38.50039302678194, 38.61461854791719, 38.715937058982696, 38.77559995290877],
            #       [27.9333862588912, 30.759121037095852, 32.141259826673895, 33.18598995234525, 34.00815090226458, 34.60217649382672, 35.15086927417873, 35.59509140486922, 35.94186120259133, 36.38182691268033, 36.72820090758948, 37.01043361839247, 37.32245235469616, 37.665785432875886, 37.945568130154804, 38.17132237983089, 38.392806009700436, 38.59870313050175, 38.77874613467547, 38.912816098264045, 39.0146632409059, 39.14489197324717, 39.25693569996423, 39.38427578112348, 39.53741392258823, 39.67330950176715, 39.74154665268105, 39.83429052863166, 39.95039910488929],
            #       [28.54597030648407, 31.413031524370666, 32.88488737266254, 33.994586309744214, 34.89159676640045, 35.655910581601184, 36.17748138085676, 36.60637197640559, 37.10189241677851, 37.477918916664805, 37.75751743259927, 38.04197142398027, 38.2871897481234, 38.58289430470805, 38.87057965981462, 39.1156698273543, 39.43108850017686, 39.614015798837976, 39.76457418731131, 39.927003762849665, 40.10370246403407, 40.281079990672865, 40.4243502489342, 40.63926084554197, 40.75522180096049, 40.876189473541494, 40.93130404293302, 41.02466762390375, 41.12086467163636],
            #       [28.988407698189324, 31.922628068698184, 33.485643355952966, 34.58842738955365, 35.35974259183226, 35.97595678186215, 36.5030603157354, 37.004556480143, 37.45159383424016, 37.78936163705444, 38.144840772145024, 38.35991923398011, 38.64784751675626, 38.88843612765867, 39.14893760626659, 39.399400041754575, 39.563754513360436, 39.71723679888217, 39.86198751298842, 40.082370813926815, 40.25926706173881, 40.34502583414959, 40.469897655148785, 40.562666083275964, 40.691428733209506, 40.87024384369482, 40.97341143400297, 41.10075003832236, 41.20487651907233],
            #       [29.038791118688938, 32.09152954873555, 33.72924966823204, 34.84827787645355, 35.77060063904247, 36.400949976185565, 36.89132755321491, 37.29063620512483, 37.76387182544818, 38.0864762883815, 38.45290536962399, 38.834574581079025, 39.21313329620811, 39.455998902275205, 39.77981674115881, 40.07538762428398, 40.33644802895363, 40.54970446081917, 40.854165587678935, 41.065154661101616, 41.19141219523207, 41.31407347988437, 41.39367658065146, 41.46992373724863, 41.57899776015685, 41.71821466105902, 41.91493234184014, 42.02455720858125, 42.11661912899908]][n-2][k-1]
            
            
 
    
    
        if k == 48:
            h = h_type
        
        
        R = compute_recursive_residuals(cluster_trans)
        U = transform_to_U(R)
        M = calc_M(U, Lambda)
        T2_list, lim_list = calc_T2_and_limits(M, Lambda, h)
        
 

        # Check if UCL has been exceeded
        count = 0
        state = []
        for x,y in zip(T2_list, lim_list):
            
            if x > y:
                state.append("OOC")
                count += 1
            else:
                state.append("IC")
       

        result_df[index] = {"Norm" : T2_list, "Limit" : lim_list, "Num_OOC": count, "state": state, "h": h}
            
        index += 1
           
            
            
    return result_df



